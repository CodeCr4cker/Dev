<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dev Chat ‚Äî Divyanshu Pandey</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts and minimal icons for clean UI -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <style>
    html,body {height:100%;margin:0;padding:0;}
    body {
        background: #10151B;
        color: #e0e4e8;
        font-family: 'Inter', sans-serif;
        height: 100vh;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
    }
    .container {
        background: #171e25;
        border-radius: 16px;
        box-shadow: 0 6px 32px #000c  ;
        max-width: 370px;
        width: 100%;
        margin: 16px;
        padding: 0;
        min-height: 540px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        position: relative;
    }
    .brand-bar {
        background: linear-gradient(90deg,#007ACC,#28A745 80%);
        color: #fff;
        font-weight: 700;
        font-size: 1.32rem;
        letter-spacing: 2px;
        text-align: center;
        padding: 1.1rem 0 .7rem 0;
    }

    .auth-panel, .chat-panel { display: none; flex:1 1 auto; flex-direction:column; justify-content:center; align-items:center; padding:2rem 8%; }
    .auth-panel.active, .chat-panel.active { display: flex;}
    .auth-form {background: #11171f; padding: 1.2rem 1.3rem 1.4rem; border-radius:9px; box-shadow: 0 3px 10px #0004; width: 100%;}
    .auth-form h2 {margin-top:0;text-align:center;color:#7ad3fd;}
    .auth-form label {display:block;margin-top:10px;font-size:0.93rem;}
    .auth-form input {width:100%;padding:.7rem;margin-top:.3rem;border:none;background:#121921;color:#e0e4e8;border-radius:6px;}
    .auth-form button {width:100%;padding:.8rem;margin-top:1.3rem;background:#007ACC;color:#fff;font-weight:700;border:none;border-radius:7px;font-size:1rem;letter-spacing:1.2px;cursor:pointer;transition:.2s;}
    .auth-form button:hover {background:#005F99;}
    .auth-alt {margin-top:1.4rem;text-align:center; font-size: .98rem;}
    .auth-alt a {color:#28A745;}

    /* Chat UI */
    .chat-panel {flex:1;flex-direction:column;}
    .chat-header {
        background:linear-gradient(90deg,#007ACC,#6C757D 98%);
        color:#fff;padding:1.05rem 1.5rem;
        font-size:1.15rem;font-weight:700;
        display:flex;align-items:center;
        gap:.7rem;letter-spacing:0.6px;position:sticky;top:0;
    }
    .chat-header .avatar {
        background: #fff; color: #007ACC; font-weight: bold; width: 34px; height: 34px; border-radius:50%; display:flex; justify-content:center; align-items:center; font-size:1.3em; box-shadow: 0 1px 5px #0005;
        border: 2px solid #28A745;
    }
    .chat-messages {
        flex: 1 1 auto;
        padding: 1.4rem 1rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap:.5rem;
    }
    .chat-msg {
        max-width: 80%;
        padding: .7em .93em;
        border-radius: 12px;
        display: block;
        font-size: 1.01em;
        word-break:break-word;
    }
    .mine {
        align-self: flex-end;
        background: linear-gradient(80deg,#007ACC 60%,#005F99);
        color: #fff;
        border-bottom-right-radius: 0;
    }
    .theirs {
        align-self: flex-start;
        background: #222d37;
        border-bottom-left-radius: 0;
        color: #bdefff;
    }
    .chat-sendbar {
        display: flex;
        padding: 1rem;
        gap: 0.6rem;
        border-top: 1px solid #223;
        background: #151a20;
    }
    .chat-sendbar input {
        flex: 1;
        padding: 0.7em .9em;
        border: none;
        border-radius: 6px;
        background: #222d2b;
        color: #e0e4e8;
        font-size: 1rem;
    }
    .chat-sendbar button {
        background: #28A745;
        border: none;
        color: #fff;
        border-radius: 7px;
        padding: 0 1.3em;
        cursor: pointer;
        font-weight: 700;
        font-size: 1.1em;
        transition: background .22s;
    }
    .chat-sendbar button:hover {background: #217c34;}
    .chat-logout {
        position:absolute;top:1.1rem;right:1.1rem;
        color:#e0e0e0;background:none;border:none;cursor:pointer;
        font-size:1.04em;
        font-weight:600;letter-spacing:.7px;
        padding:.15em .9em;
        border-radius:6px;
        background:rgba(40,100,200,0.05);
        transition:background 0.2s;
    }
    .chat-logout:hover {background:#373a3f3e;color:#ff7a7a;}
    .info-msg {
        margin: 1.5rem 0 .5rem;
        color: #ffeb3b;
        background:#232525 ;
        border-radius:7px;padding:.8em;margin-inline:auto;text-align:center;font-size:.96em;
    }
    @media (max-width: 600px) {
        .container {max-width:100vw;min-height:100vh;border-radius:0;}
        .auth-panel, .chat-panel {padding: 0.8rem 2%;}
        .chat-header {font-size:1.02rem;padding:.62rem .7rem;}
    }
    </style>
</head>
<body>
<div class="container">

    <div class="brand-bar">Developer Chat</div>

    <div class="auth-panel active" id="auth-panel">
        <form class="auth-form" id="signup-form">
            <h2>Sign up</h2>
            <label>Email</label>
            <input type="email" required id="signup-email" placeholder="Enter your email">
            <label>Password</label>
            <input type="password" required id="signup-password" placeholder="At least 6 characters">
            <button type="submit">Create Account</button>
            <div class="auth-alt">
                Already registered? <a href="#" id="goto-login">Login</a>
            </div>
        </form>
        <form class="auth-form" id="login-form" style="display:none;">
            <h2>Login</h2>
            <label>Email</label>
            <input type="email" required id="login-email" placeholder="Enter your email">
            <label>Password</label>
            <input type="password" required id="login-password" placeholder="Password">
            <button type="submit">Sign In</button>
            <div class="auth-alt">
                No account? <a href="#" id="goto-signup">Sign Up</a>
            </div>
        </form>
        <div id="auth-error" class="info-msg" style="display:none;"></div>
    </div>

    <div class="chat-panel" id="chat-panel">
        <button class="chat-logout" id="logoutBtn" title="Logout">Logout</button>
        <div class="chat-header">
            <div class="avatar">D</div>
            <span>Developer</span>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <form class="chat-sendbar" id="send-message-form">
            <input type="text" id="message-input" placeholder="Type your message..." maxlength="800" autocomplete="off" required>
            <button type="submit">Send</button>
        </form>
    </div>
</div>

<!-- Firebase App (modular) -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script>
/* ====== CONFIGURATION: Fill these in with your Firebase creds ====== */
const firebaseConfig = {
    apiKey: "YOUR_API_KEY_HERE",
    authDomain: "YOUR_AUTH_DOMAIN.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_BUCKET.appspot.com",
    messagingSenderId: "YOUR_MSG_SENDER_ID",
    appId: "YOUR_APP_ID"
};
/* ================================================================ */

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* -- DEVELOPER ACCOUNT CONSTANTS -- */
const DEV_EMAIL = "devloper.85@gmail.com";
const DEV_DEFAULT_PASS = "DefaultDev@123"; // Recommend override for production

// Optionally: store a secret token in env/config only known to the real web app (for fallback)
const DEV_ACCOUNT_SECRET = "UltraSecretToken123!"; // change this for fallback, don't expose in prod


/* ===== FIRESTORE SCHEMA EXAMPLES =====
 users/{userId}: {
   email: string,
   displayName: string | undefined,
   createdAt: Timestamp
 }
 chats/{chatId}: {
   participants: [userId, devUserId],
   lastUpdated: Timestamp
 }
 chats/{chatId}/messages/{messageId}: {
   senderId: uid,
   text: string,
   timestamp: Timestamp,
   status: "sent"|"delivered"
 }
 Single chat per user + dev: chatId = `${userId}_${devUserId}` or sorted ids.
 ======================================================
*/

/* ------------------------- UI UTILS -------------------------- */
function showPanel(id) {
    document.querySelectorAll('.auth-panel,.chat-panel').forEach(el=>el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}
function showError(msg) {
    const el = document.getElementById("auth-error");
    el.textContent = msg;
    el.style.display = "";
    setTimeout(()=>{el.style.display='none';},4300);
}

/* -------- AUTH: Signup, Login, Dev Account Fallback --------- */

document.getElementById('goto-login').onclick = e => {
    e.preventDefault();
    document.getElementById('signup-form').style.display="none";
    document.getElementById('login-form').style.display="";
};
document.getElementById('goto-signup').onclick = e => {
    e.preventDefault();
    document.getElementById('signup-form').style.display="";
    document.getElementById('login-form').style.display="none";
};

document.getElementById('signup-form').onsubmit = async function(e) {
    e.preventDefault();
    const email = document.getElementById("signup-email").value.trim();
    const pass = document.getElementById("signup-password").value;
    try {
        if(email.toLowerCase() === DEV_EMAIL)
            throw new Error("This email is reserved for the developer.");
        await ensureDevAccountExists();
        let cred = await auth.createUserWithEmailAndPassword(email, pass);
        await afterLogin(cred.user);
    } catch(err) {
        showError(err.message);
    }
};
document.getElementById('login-form').onsubmit = async function(e) {
    e.preventDefault();
    const email = document.getElementById("login-email").value.trim();
    const pass = document.getElementById("login-password").value;
    try {
        await ensureDevAccountExists();
        let cred = await auth.signInWithEmailAndPassword(email, pass);
        await afterLogin(cred.user);
    } catch(err) {
        showError(err.message);
    }
};
// Logout
document.getElementById("logoutBtn").onclick = async function() {
    await auth.signOut();
    showPanel('auth-panel');
};

/* --------- Chat UI and Logic --------- */
async function afterLogin(user) {
    // Store user profile if first login
    const userRef = db.collection("users").doc(user.uid);
    const doc = await userRef.get();
    if (!doc.exists) {
        await userRef.set({
            email: user.email,
            displayName: user.displayName||"",
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        });
    }
    showPanel('chat-panel');
    loadChat(user);
}
auth.onAuthStateChanged(user => {
    // (optionally re-check dev account here)
    if(user) { afterLogin(user); }
    else showPanel('auth-panel');
});

// -- Main chat logic
let chatUnsub = null;
async function loadChat(user) {
    // Always between user <-> developer chat
    let devUserDoc = await findDeveloperUser();
    if(!devUserDoc) {
        showError("Developer not available. Try again later.");
        return;
    }
    // deterministically generate chatId
    const ids = [user.uid, devUserDoc.id].sort();
    const chatId = ids.join("_");
    const chatRef = db.collection("chats").doc(chatId);

    // Create chat doc if not existing
    await chatRef.set({
        participants: ids,
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
    }, {merge:true});

    // Load chat messages
    const msgsDiv = document.getElementById("chat-messages");
    msgsDiv.innerHTML = "<div style='color:#41ff9d;text-align:center;margin:1.8em 0 1em;'>Welcome! üëã You can chat directly with the developer.<br>This is a private channel.</div>";
    if(chatUnsub) chatUnsub();

    chatUnsub = chatRef.collection("messages").orderBy("timestamp")
        .onSnapshot(qs => {
            msgsDiv.innerHTML = "";
            if(qs.size === 0)
                msgsDiv.innerHTML = "<div style='text-align:center;color:#aaa;margin-top:2.5em;'>No messages yet.</div>";
            qs.forEach(doc=>{
                const m = doc.data();
                const cls = m.senderId===user.uid ? "chat-msg mine":"chat-msg theirs";
                const avatar = m.senderId===user.uid ? "" : "<span style='font-size:.95em;color:#90fbcb'>Dev:</span><br>";
                msgsDiv.innerHTML += `<div class='${cls}'>${avatar}${escapeHTML(m.text)}</div>`;
            });
            // auto-scroll to latest
            msgsDiv.scrollTop = msgsDiv.scrollHeight;
        });

    // Send bar
    const sendForm = document.getElementById("send-message-form");
    sendForm.onsubmit = async function(e){
        e.preventDefault();
        const input = document.getElementById("message-input");
        const text = input.value.trim();
        if(!text) return;
        await chatRef.collection("messages").add({
            senderId: user.uid,
            text,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            status: "sent"
        });
        await chatRef.set({lastUpdated: firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
        input.value = "";
    }
}

/* -- Find the DEV user's Auth uid by Firestore (assuming their user doc is present) -- */
async function findDeveloperUser() {
    // Look by email in users collection
    const snap = await db.collection("users")
        .where("email", "==", DEV_EMAIL).limit(1).get();
    if(snap.empty) return null;
    return {id: snap.docs[0].id, ...snap.docs[0].data()};
}

/* -- Secure (Fallback) client-based developer account check/creation -- */
/*
    WARNING:
    This is less secure compared to the preferred Cloud Function solution.
    Only enable this fallback while developing, NEVER expose your admin/dev password or special tokens in public JS code for production use.
    For real launches: move to an Admin SDK method/cloud function for any account bootstrap, not client-side!
*/
async function ensureDevAccountExists() {
    // Dev user must have a Firestore 'users' doc and their Auth account must exist.
    // Try to query their user doc, if missing: try to programatically create (using Cloud Function, preferred).
    const devUser = await findDeveloperUser();
    if(devUser) return; // user doc found, assume account exists

    // FALLBACK: Try to create dev account with a "secret"
    // (Fires only if dev user absent in "users")
    // For security:
    // * Only try create if you have a secret/token (never run on public client).
    // * This is for demo purposes - REMOVE/disable in prod and use a Cloud Function solution!
    if(DEV_ACCOUNT_SECRET === "UltraSecretToken123!") { // Set your own (env), don't hardcode for prod.
        try {
            // Try to register the dev user:
            // Must sign out, since "createUser..." can't be called if anyone is logged in
            if(auth.currentUser) await auth.signOut();
            let cu = await auth.createUserWithEmailAndPassword(DEV_EMAIL, DEV_DEFAULT_PASS);
            // Write their Firestore profile:
            await db.collection("users").doc(cu.user.uid).set({
                email: DEV_EMAIL,
                displayName: "Developer",
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            // Log them out so that normal user can continue:
            await auth.signOut();
        } catch(err) {
            // If already exists, or forbidden, that's ok!
        }
    } else {
        throw new Error("Dev account bootstrap is not enabled (missing fallback secret). Contact app owner.");
    }
}
/* Output a warning to console so you know to disable this fallback in prod. */
console.warn("‚ö†Ô∏è Client-side dev account creation is for DEV/TESTING only!  Use the provided Cloud Function in production! ‚ö†Ô∏è");

/* ------ XSS Protection for chat output ------- */
function escapeHTML(str) {
    return str.replace(/[&<>"]/g, function(tag) {
        const chars = {"&": "&amp;","<": "&lt;",">": "&gt;",'"':"&quot;"};
        return chars[tag] || tag;
    });
}
</script>
</body>
</html>